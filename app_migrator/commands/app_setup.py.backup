import click
import os
from .api_keys import load_keys, save_keys, classify_key
from .cloud_api import FrappeCloudAPI

@click.command("quick-setup")
@click.option("--fc-key", prompt="Frappe Cloud API Key", hide_input=True, help="Your Frappe Cloud API key")
@click.option("--fc-secret", prompt="Frappe Cloud API Secret", hide_input=True, help="Your Frappe Cloud API secret")
def quick_setup(fc_key, fc_secret):
    """Quick setup with Frappe Cloud API credentials."""
    data = load_keys()
    data["frappe_cloud_key"] = fc_key
    data["frappe_cloud_secret"] = fc_secret
    data["fc_key_type"] = classify_key(fc_key)
    save_keys(data)
    
    click.secho("✅ Frappe Cloud API credentials saved!", fg="green")
    
    # Test the connection
    api = FrappeCloudAPI(fc_key, fc_secret)
    sites = api.get_sites()
    
    if sites:
        click.echo(f"Found {len(sites)} sites accessible")
        click.echo("Available sites:")
        for site in sites[:5]:  # Show first 5 sites
            click.echo(f"  - {site.get('name')} ({site.get('status')})")
        if len(sites) > 5:
            click.echo(f"  ... and {len(sites) - 5} more")
    else:
        click.secho("⚠️ Could not fetch sites. Check your credentials.", fg="yellow")

@click.command("simple-api-setup")
@click.option("--site-url", prompt="Site URL (e.g., sysmayal.frappe.cloud)", help="Your Frappe site URL")
@click.option("--site-key", prompt="Site API Key", hide_input=True, help="Site user API key")
@click.option("--site-secret", prompt="Site API Secret", hide_input=True, help="Site user API secret")
def simple_api_setup(site_url, site_key, site_secret):
    """Setup site-specific API credentials."""
    data = load_keys()
    data["site_url"] = site_url
    data["site_api_key"] = site_key
    data["site_api_secret"] = site_secret
    data["site_key_type"] = classify_key(site_key)
    save_keys(data)
    
    click.secho("✅ Site API credentials saved!", fg="green")
    
    # Test connection
    from .cloud_api import SiteAPI
    site_api = SiteAPI(site_url, site_key, site_secret)
    if site_api.ping():
        click.secho("✅ Successfully connected to site!", fg="green")
    else:
        click.secho("⚠️ Could not connect to site. Check credentials.", fg="yellow")

@click.command("setup-wizard")
def setup_wizard():
    """Interactive setup wizard for both Frappe Cloud and Site APIs."""
    click.echo("\n" + "="*60)
    click.echo("Frappe Cloud App Migrator Setup Wizard")
    click.echo("="*60)
    
    data = load_keys()
    
    # Step 1: Frappe Cloud API Setup
    click.echo("\nStep 1: Frappe Cloud API Setup")
    click.echo("-" * 40)
    
    if data.get("frappe_cloud_key"):
        click.echo(f"Existing key found: {data['frappe_cloud_key'][:8]}...")
        if not click.confirm("Do you want to update Frappe Cloud credentials?"):
            click.echo("Using existing credentials.")
        else:
            fc_key = click.prompt("Enter Frappe Cloud API Key", hide_input=True)
            fc_secret = click.prompt("Enter Frappe Cloud API Secret", hide_input=True)
            data["frappe_cloud_key"] = fc_key
            data["frappe_cloud_secret"] = fc_secret
    else:
        fc_key = click.prompt("Enter Frappe Cloud API Key", hide_input=True)
        fc_secret = click.prompt("Enter Frappe Cloud API Secret", hide_input=True)
        data["frappe_cloud_key"] = fc_key
        data["frappe_cloud_secret"] = fc_secret
    
    # Test Frappe Cloud connection
    click.echo("\nTesting Frappe Cloud connection...")
    api = FrappeCloudAPI(data["frappe_cloud_key"], data["frappe_cloud_secret"])
    sites = api.get_sites()
    
    if sites:
        click.secho(f"✅ Success! Found {len(sites)} sites.", fg="green")
        # Let user select a site
        site_names = [site["name"] for site in sites]
        if site_names:
            click.echo("\nAvailable sites:")
            for i, name in enumerate(site_names[:10], 1):
                click.echo(f"  {i}. {name}")
            
            if click.confirm("\nDo you want to configure API access for one of these sites?"):
                # Step 2: Site API Setup
                click.echo("\nStep 2: Site API Setup")
                click.echo("-" * 40)
                
                site_url = click.prompt("Enter site URL (from above list)")
                site_key = click.prompt("Enter Site API Key", hide_input=True)
                site_secret = click.prompt("Enter Site API Secret", hide_input=True)
                
                data["site_url"] = site_url
                data["site_api_key"] = site_key
                data["site_api_secret"] = site_secret
                
                # Test site connection
                click.echo("\nTesting site connection...")
                from .cloud_api import SiteAPI
                site_api = SiteAPI(site_url, site_key, site_secret)
                if site_api.ping():
                    click.secho("✅ Successfully connected to site!", fg="green")
                else:
                    click.secho("⚠️ Could not connect to site.", fg="yellow")
    
    # Save all data
    save_keys(data)
    click.secho("\n✅ Setup complete! Use 'bench app-migrator api-key-status' to view credentials.", fg="green")
